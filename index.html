<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Civitas - Strategy Game</title>
    <!-- Mobile friendly viewport -->
    <meta
        name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover"
    />

    <!-- Tailwind + React + Babel -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        html,
        body {
            margin: 0;
            padding: 0;
            height: 100%;
        }

        body {
            -webkit-font-smoothing: antialiased;
            text-rendering: optimizeLegibility;
            background: #020617; /* slate-950 */
        }

        #root {
            height: 100%;
        }

        /* Custom scrollbar (for the in-game scroll area only) */
        .game-scroll::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        .game-scroll::-webkit-scrollbar-track {
            background: rgba(15, 23, 42, 0.7);
        }

        .game-scroll::-webkit-scrollbar-thumb {
            background: #64748b;
            border-radius: 3px;
        }

        .pixel-font {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono",
                "Courier New", monospace;
        }

        /* Safe-area helpers for iOS notches */
        :root {
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
        }

        .safe-top {
            padding-top: var(--safe-top);
        }

        .safe-bottom {
            padding-bottom: var(--safe-bottom);
        }

        /* Animation for resources update (unused but ready) */
        @keyframes pop {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.12);
            }
            100% {
                transform: scale(1);
            }
        }

        .res-pop {
            animation: pop 0.2s ease-in-out;
        }

        /* Remove tap highlight on mobile */
        * {
            -webkit-tap-highlight-color: transparent;
        }
    </style>

</head>
<body class="select-none">
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;

        // Icons (simple inline SVGs)
        const Icons = {
            Wood: () => (
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="16"
                    height="16"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    strokeWidth="2"
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    className="text-amber-500"
                >
                    <path d="M12 10a6 6 0 0 0-6-6c-2 0-4 1-4 6 0 4 2 6 5 8 4 3 8 4 8 4s5-1 8-4c3-2 5-4 5-8 0-5-2-6-4-6-4 0-6 6-6 6Z" />
                    <path d="M8 14v8" />
                    <path d="M16 14v8" />
                    <path d="M12 14v8" />
                </svg>
            ),
            Clay: () => (
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="16"
                    height="16"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    strokeWidth="2"
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    className="text-orange-600"
                >
                    <rect width="18" height="18" x="3" y="3" rx="2" />
                    <path d="M3 9h18" />
                    <path d="M3 15h18" />
                    <path d="M9 3v18" />
                    <path d="M15 3v18" />
                </svg>
            ),
            Iron: () => (
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="16"
                    height="16"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    strokeWidth="2"
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    className="text-slate-300"
                >
                    <path d="m2 22 1-1h3l9-9" />
                    <path d="M3 21v-3l9-9" />
                    <path d="m15 6 3.4-3.4a2.1 2.1 0 1 1 3 3L5 21l-3 1 1-3L19 3a2 1 2 1 0 0 1 3 3l-7 7" />
                </svg>
            ),
            Crop: () => (
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="16"
                    height="16"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    strokeWidth="2"
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    className="text-yellow-400"
                >
                    <path
                        d="M12 22a4.5 4.5 0 0 0 1.3-3.2c0-4.6-4-6.3-3.6-11.6 1.6-1.5 3.4-1.1 4.6-1.1.4 3.6 2.7 5.7 4 8.9.6 2.5-.3 6.9-2 8.3"
                    />
                </svg>
            ),
            Sword: () => (
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="18"
                    height="18"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    strokeWidth="2"
                    strokeLinecap="round"
                    strokeLinejoin="round"
                >
                    <polyline points="14.5 17.5 3 6 3 3 6 3 17.5 14.5" />
                    <line x1="13" x2="19" y1="19" y2="13" />
                    <line x1="16" x2="20" y1="16" y2="20" />
                    <line x1="19" x2="21" y1="21" y2="19" />
                </svg>
            ),
            Home: () => (
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="22"
                    height="22"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    strokeWidth="2"
                    strokeLinecap="round"
                    strokeLinejoin="round"
                >
                    <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />
                    <polyline points="9 22 9 12 15 12 15 22" />
                </svg>
            ),
            Map: () => (
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="22"
                    height="22"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    strokeWidth="2"
                    strokeLinecap="round"
                    strokeLinejoin="round"
                >
                    <polygon points="3 6 9 3 15 6 21 3 21 18 15 21 9 18 3 21" />
                    <line x1="9" x2="9" y1="3" y2="18" />
                    <line x1="15" x2="15" y1="6" y2="21" />
                </svg>
            ),
            Timer: () => (
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="14"
                    height="14"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    strokeWidth="2"
                    strokeLinecap="round"
                    strokeLinejoin="round"
                >
                    <circle cx="12" cy="12" r="10" />
                    <polyline points="12 6 12 12 16 14" />
                </svg>
            ),
            X: () => (
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    strokeWidth="2"
                    strokeLinecap="round"
                    strokeLinejoin="round"
                >
                    <path d="M18 6 6 18" />
                    <path d="m6 6 12 12" />
                </svg>
            ),
        };

        // Game Constants
        const TICK_RATE = 1000; // 1 second ticks
        const SAVE_KEY = "civitas_save_v1";
        const SPEED_MULTIPLIER = 5; // Speed server!

        const BUILDING_TYPES = {
            woodcutter: { name: "Woodcutter", cost: [40, 100, 50, 60], prod: 10, type: "resource", resType: "wood" },
            claypit: { name: "Clay Pit", cost: [80, 40, 80, 50], prod: 10, type: "resource", resType: "clay" },
            ironmine: { name: "Iron Mine", cost: [100, 80, 30, 60], prod: 10, type: "resource", resType: "iron" },
            cropland: { name: "Cropland", cost: [70, 90, 70, 20], prod: 10, type: "resource", resType: "crop" },
            mainbuilding: {
                name: "Main Building",
                cost: [75, 40, 60, 20],
                type: "infrastructure",
                desc: "Reduces construction time.",
            },
            warehouse: {
                name: "Warehouse",
                cost: [130, 160, 90, 40],
                type: "infrastructure",
                desc: "Increases resource capacity.",
            },
            granary: {
                name: "Granary",
                cost: [80, 100, 70, 20],
                type: "infrastructure",
                desc: "Increases crop capacity.",
            },
            barracks: {
                name: "Barracks",
                cost: [210, 140, 130, 120],
                type: "infrastructure",
                desc: "Trains infantry.",
            },
        };

        const INITIAL_STATE = {
            resources: { wood: 750, clay: 750, iron: 750, crop: 750 },
            maxStorage: 800,
            maxGranary: 800,
            population: 1,
            fields: Array(18)
                .fill(0)
                .map((_, i) => {
                    if (i < 4) return { type: "woodcutter", level: 0 };
                    if (i < 8) return { type: "claypit", level: 0 };
                    if (i < 12) return { type: "ironmine", level: 0 };
                    return { type: "cropland", level: 0 };
                }),
            buildings: [
                { type: "mainbuilding", level: 1, id: "mb1" },
                { type: null, level: 0, id: "b2" },
                { type: null, level: 0, id: "b3" },
                { type: null, level: 0, id: "b4" },
                { type: null, level: 0, id: "b5" },
                { type: null, level: 0, id: "b6" },
                { type: null, level: 0, id: "b7" },
                { type: null, level: 0, id: "b8" },
            ],
            constQueue: [],
            troops: { legionnaire: 0 },
            trainingQueue: [],
            missions: [],
            reports: [],
            // Quests system
            quests: [
                {
                    id: 1,
                    title: "First Steps",
                    desc: "Upgrade any resource field to level 1.",
                    type: "fieldLevel",
                    targetLevel: 1,
                    completed: false,
                    claimed: false,
                },
                {
                    id: 2,
                    title: "Storage Solutions",
                    desc: "Build a Warehouse in your village.",
                    type: "buildBuilding",
                    buildingType: "warehouse",
                    completed: false,
                    claimed: false,
                },
                {
                    id: 3,
                    title: "Raise an Army",
                    desc: "Reach 10 Legionnaires.",
                    type: "troopsCount",
                    unit: "legionnaire",
                    target: 10,
                    completed: false,
                    claimed: false,
                },
            ],
        };

        const formatNum = (n) => Math.floor(n).toLocaleString();

        const getCost = (type, level) => {
            const base = BUILDING_TYPES[type].cost;
            const mult = Math.pow(1.5, level);
            return base.map((c) => Math.floor(c * mult));
        };

        const getProduction = (type, level) => {
            if (level === 0) return 2 * SPEED_MULTIPLIER;
            return Math.floor(BUILDING_TYPES[type].prod * level * 1.5 * SPEED_MULTIPLIER);
        };

        const getMainBuildingLevel = (buildings) => {
            const mb = buildings.find((b) => b.type === "mainbuilding");
            return mb ? mb.level : 0;
        };

        const getBarracksLevel = (buildings) => {
            const b = buildings.find((b) => b.type === "barracks");
            return b ? b.level : 0;
        };

        function App() {
            const [state, setState] = useState(() => {
                const saved = localStorage.getItem(SAVE_KEY);
                if (saved) {
                    const parsed = JSON.parse(saved);
                    return {
                        ...INITIAL_STATE,
                        ...parsed,
                        quests: parsed.quests || INITIAL_STATE.quests,
                    };
                }
                return INITIAL_STATE;
            });

            const [activeTab, setActiveTab] = useState("fields");
            const [selectedSlot, setSelectedSlot] = useState(null);
            const [modalOpen, setModalOpen] = useState(false);

            // --- GAME LOOP ---
            useEffect(() => {
                const interval = setInterval(() => {
                    const now = Date.now();
                    setState((prev) => {
                        const next = { ...prev };

                        // 1. Production
                        let prod = { wood: 0, clay: 0, iron: 0, crop: 0 };
                        next.fields.forEach((f) => {
                            const type = f.type;
                            const resType = BUILDING_TYPES[type].resType;
                            if (f.level > 0) {
                                prod[resType] += getProduction(type, f.level);
                            } else {
                                prod[resType] += 2 * SPEED_MULTIPLIER;
                            }
                        });

                        // 2. Crop consumption
                        const troopUpkeep = next.troops.legionnaire;
                        const popUpkeep = next.population;
                        const netCrop = prod.crop - troopUpkeep - popUpkeep;

                        // 3. Add resources (prod is hourly, scaled to tick)
                        const addRes = (key, amount) => {
                            const max = key === "crop" ? next.maxGranary : next.maxStorage;
                            next.resources[key] = Math.min(
                                max,
                                next.resources[key] + (amount / 3600) * TICK_RATE
                            );
                        };

                        addRes("wood", prod.wood);
                        addRes("clay", prod.clay);
                        addRes("iron", prod.iron);
                        next.resources.crop = Math.min(
                            next.maxGranary,
                            Math.max(0, next.resources.crop + (netCrop / 3600) * TICK_RATE)
                        );

                        // 4. Construction queue
                        const completedConst = [];
                        next.constQueue = next.constQueue.filter((q) => {
                            if (q.finishTime <= now) {
                                completedConst.push(q);
                                return false;
                            }
                            return true;
                        });

                        completedConst.forEach((c) => {
                            if (c.isField) {
                                next.fields[c.index].level = c.level;
                            } else {
                                next.buildings[c.index].type = c.type;
                                next.buildings[c.index].level = c.level;
                                if (c.type === "warehouse") next.maxStorage += c.level * 800;
                                if (c.type === "granary") next.maxGranary += c.level * 800;
                            }
                            next.population += 2;
                        });

                        // 5. Training queue
                        const completedTraining = [];
                        next.trainingQueue = next.trainingQueue.filter((q) => {
                            if (q.finishTime <= now) {
                                completedTraining.push(q);
                                return false;
                            }
                            return true;
                        });

                        completedTraining.forEach((q) => {
                            next.troops.legionnaire += q.amount;
                        });

                        // 6. Missions
                        const returningMissions = [];
                        next.missions = next.missions.filter((m) => {
                            if (m.returnTime <= now) {
                                returningMissions.push(m);
                                return false;
                            }
                            return true;
                        });

                        returningMissions.forEach((m) => {
                            if (m.type === "raid") {
                                // Casualties: small but noticeable risk
                                const casualtyRate = 0.1 + Math.random() * 0.25; // 10â€“35%
                                const lost = Math.floor(m.troops * casualtyRate);
                                const survivors = Math.max(0, m.troops - lost);

                                const lootMultiplier = survivors; // survivors determine how much you can carry
                                const loot = {
                                    wood: Math.floor(Math.random() * 80 * lootMultiplier),
                                    clay: Math.floor(Math.random() * 80 * lootMultiplier),
                                    iron: Math.floor(Math.random() * 80 * lootMultiplier),
                                    crop: Math.floor(Math.random() * 80 * lootMultiplier),
                                };

                                next.reports.unshift({
                                    id: Date.now() + Math.random(),
                                    title: `Raid on ${m.target}`,
                                    loot,
                                    time: new Date().toLocaleTimeString(),
                                    troopsSent: m.troops,
                                    troopsLost: lost,
                                    troopsReturned: survivors,
                                });

                                next.troops.legionnaire += survivors;

                                next.resources.wood = Math.min(
                                    next.maxStorage,
                                    next.resources.wood + loot.wood
                                );
                                next.resources.clay = Math.min(
                                    next.maxStorage,
                                    next.resources.clay + loot.clay
                                );
                                next.resources.iron = Math.min(
                                    next.maxStorage,
                                    next.resources.iron + loot.iron
                                );
                                next.resources.crop = Math.min(
                                    next.maxGranary,
                                    next.resources.crop + loot.crop
                                );
                            }
                        });

                        // 7. Quests auto-completion checks
                        if (next.quests && next.quests.length) {
                            next.quests = next.quests.map((q) => {
                                if (q.completed) return q;

                                switch (q.type) {
                                    case "fieldLevel": {
                                        const anyField = next.fields.some(
                                            (f) => f.level >= q.targetLevel
                                        );
                                        return anyField ? { ...q, completed: true } : q;
                                    }
                                    case "buildBuilding": {
                                        const hasBuilding = next.buildings.some(
                                            (b) => b.type === q.buildingType && b.level > 0
                                        );
                                        return hasBuilding ? { ...q, completed: true } : q;
                                    }
                                    case "troopsCount": {
                                        const count = next.troops[q.unit] || 0;
                                        return count >= q.target ? { ...q, completed: true } : q;
                                    }
                                    default:
                                        return q;
                                }
                            });
                        }

                        return next;
                    });
                }, TICK_RATE);

                return () => clearInterval(interval);
            }, []);

            // Save
            useEffect(() => {
                localStorage.setItem(SAVE_KEY, JSON.stringify(state));
            }, [state]);

            // --- ACTIONS ---
            const upgradeBuilding = (type) => {
                if (!selectedSlot) return;
                const { index, isField, level } = selectedSlot;
                const costs = getCost(type, level);

                if (
                    state.resources.wood < costs[0] ||
                    state.resources.clay < costs[1] ||
                    state.resources.iron < costs[2] ||
                    state.resources.crop < costs[3]
                ) {
                    alert("Not enough resources!");
                    return;
                }

                setState((prev) => {
                    const mainLevel = getMainBuildingLevel(prev.buildings);
                    const baseTime = 10000; // ms
                    const timeFactor = 1 - Math.min(0.4, mainLevel * 0.05); // up to 40% faster
                    const buildTime = (baseTime * timeFactor) / SPEED_MULTIPLIER;

                    return {
                        ...prev,
                        resources: {
                            wood: prev.resources.wood - costs[0],
                            clay: prev.resources.clay - costs[1],
                            iron: prev.resources.iron - costs[2],
                            crop: prev.resources.crop - costs[3],
                        },
                        constQueue: [
                            ...prev.constQueue,
                            {
                                type,
                                index,
                                level: level + 1,
                                finishTime: Date.now() + buildTime,
                                isField,
                            },
                        ],
                    };
                });
                setModalOpen(false);
            };

            const trainTroops = (amount) => {
                const costPerUnit = [120, 100, 150, 30];
                const totalCost = costPerUnit.map((c) => c * amount);

                if (
                    state.resources.wood < totalCost[0] ||
                    state.resources.clay < totalCost[1] ||
                    state.resources.iron < totalCost[2] ||
                    state.resources.crop < totalCost[3]
                ) {
                    alert("Not enough resources!");
                    return;
                }

                setState((prev) => {
                    const barracksLevel = getBarracksLevel(prev.buildings);
                    const baseTimePerUnit = 2000; // ms
                    const timeFactor = 1 - Math.min(0.5, barracksLevel * 0.07); // up to 50% faster
                    const totalTime = (amount * baseTimePerUnit * timeFactor) / SPEED_MULTIPLIER;

                    return {
                        ...prev,
                        resources: {
                            wood: prev.resources.wood - totalCost[0],
                            clay: prev.resources.clay - totalCost[1],
                            iron: prev.resources.iron - totalCost[2],
                            crop: prev.resources.crop - totalCost[3],
                        },
                        trainingQueue: [
                            ...prev.trainingQueue,
                            {
                                type: "legionnaire",
                                amount,
                                finishTime: Date.now() + totalTime,
                            },
                        ],
                    };
                });
            };

            const sendRaid = (target) => {
                const amount = parseInt(prompt("How many Legionnaires to send?", "1"), 10);
                if (!amount || isNaN(amount) || amount <= 0) return;
                if (state.troops.legionnaire < amount) {
                    alert("Not enough troops!");
                    return;
                }

                setState((prev) => ({
                    ...prev,
                    troops: { ...prev.troops, legionnaire: prev.troops.legionnaire - amount },
                    missions: [
                        ...prev.missions,
                        {
                            target,
                            troops: amount,
                            type: "raid",
                            returnTime: Date.now() + 15000 / SPEED_MULTIPLIER,
                        },
                    ],
                }));
            };

            const claimQuest = (id) => {
                setState((prev) => {
                    const next = { ...prev };
                    const quest = next.quests.find((q) => q.id === id);
                    if (!quest || quest.claimed || !quest.completed) return prev;

                    quest.claimed = true;

                    // Simple rewards: 400 of each resource
                    const reward = 400;
                    next.resources.wood = Math.min(
                        next.maxStorage,
                        next.resources.wood + reward
                    );
                    next.resources.clay = Math.min(
                        next.maxStorage,
                        next.resources.clay + reward
                    );
                    next.resources.iron = Math.min(
                        next.maxStorage,
                        next.resources.iron + reward
                    );
                    next.resources.crop = Math.min(
                        next.maxGranary,
                        next.resources.crop + reward
                    );

                    return next;
                });
            };

            // --- UI Components ---

            const TopBar = () => (
                <header className="safe-top bg-emerald-950/95 text-amber-100 border-b border-emerald-800 px-4 py-2 flex items-center justify-between">
                    <div className="flex flex-col">
                        <span className="text-xs uppercase tracking-[0.2em] text-emerald-300">
                            Civitas
                        </span>
                        <span className="text-sm font-semibold">Village of Aurelia</span>
                    </div>
                    <div className="text-right text-[10px] text-emerald-200">
                        <div>Pop: {state.population}</div>
                        <div className="flex items-center gap-1 justify-end">
                            <Icons.Sword />
                            <span>{state.troops.legionnaire}</span>
                        </div>
                    </div>
                </header>
            );

            const ResourceBar = () => {
                const res = state.resources;
                const caps = { s: state.maxStorage, g: state.maxGranary };

                const ResItem = ({ icon: Icon, val, max }) => {
                    const pct = Math.min(100, (val / max) * 100);
                    return (
                        <div className="flex flex-col items-center flex-1 min-w-[72px] px-1">
                            <div className="flex items-center gap-1 mb-0.5">
                                <Icon />
                                <span className="text-[11px] font-mono font-semibold">
                                    {formatNum(val)}
                                </span>
                            </div>
                            <div className="w-full h-1.5 bg-slate-800 rounded-full overflow-hidden">
                                <div
                                    className="h-full bg-gradient-to-r from-emerald-400 to-amber-400 transition-all duration-300"
                                    style={{ width: pct + "%" }}
                                />
                            </div>
                        </div>
                    );
                };

                return (
                    <div className="bg-slate-900/95 border-b border-slate-800 px-2 py-2">
                        <div className="flex gap-1 overflow-x-auto game-scroll">
                            <ResItem icon={Icons.Wood} val={res.wood} max={caps.s} />
                            <ResItem icon={Icons.Clay} val={res.clay} max={caps.s} />
                            <ResItem icon={Icons.Iron} val={res.iron} max={caps.s} />
                            <ResItem icon={Icons.Crop} val={res.crop} max={caps.g} />
                        </div>
                    </div>
                );
            };

            const FieldsView = () => (
                <div className="px-4 py-4 pb-20">
                    <div className="text-center mb-3">
                        <h2 className="text-lg font-semibold text-emerald-100">Resource Fields</h2>
                        <p className="text-[11px] text-slate-300">
                            Upgrade fields to increase production.
                        </p>
                    </div>
                    <div className="grid grid-cols-3 gap-3">
                        {state.fields.map((f, i) => {
                            const isBuilding = state.constQueue.find(
                                (q) => q.isField && q.index === i
                            );
                            let borderColor = "border-slate-700 bg-slate-900/70";
                            if (f.type === "woodcutter")
                                borderColor = "border-amber-500/60 bg-amber-950/30";
                            if (f.type === "claypit")
                                borderColor = "border-orange-500/60 bg-orange-950/30";
                            if (f.type === "ironmine")
                                borderColor = "border-slate-400/60 bg-slate-950/50";
                            if (f.type === "cropland")
                                borderColor = "border-yellow-400/60 bg-yellow-950/30";

                            return (
                                <button
                                    type="button"
                                    key={i}
                                    onClick={() => {
                                        setSelectedSlot({
                                            index: i,
                                            isField: true,
                                            level: f.level,
                                            type: f.type,
                                        });
                                        setModalOpen(true);
                                    }}
                                    className={`aspect-square rounded-xl border ${borderColor} flex flex-col items-center justify-center relative shadow-sm active:scale-95 transition-transform`}
                                >
                                    <div className="font-bold text-xl text-slate-50 mb-1">
                                        {f.level}
                                    </div>
                                    {f.type === "woodcutter" && <Icons.Wood />}
                                    {f.type === "claypit" && <Icons.Clay />}
                                    {f.type === "ironmine" && <Icons.Iron />}
                                    {f.type === "cropland" && <Icons.Crop />}

                                    {isBuilding && (
                                        <div className="absolute inset-0 bg-black/40 rounded-xl flex items-center justify-center">
                                            <div className="flex items-center gap-2 text-xs text-emerald-200">
                                                <div className="animate-spin">
                                                    <Icons.Timer />
                                                </div>
                                                <span>Building...</span>
                                            </div>
                                        </div>
                                    )}
                                </button>
                            );
                        })}
                    </div>
                </div>
            );

            const VillageView = () => (
                <div className="px-4 py-4 pb-24">
                    <div className="text-center mb-3">
                        <h2 className="text-lg font-semibold text-emerald-100">Village Center</h2>
                        <p className="text-[11px] text-slate-300">
                            Construct and upgrade infrastructure.
                        </p>
                    </div>
                    <div className="grid grid-cols-2 gap-3">
                        {state.buildings.map((b, i) => {
                            const isBuilding = state.constQueue.find(
                                (q) => !q.isField && q.index === i
                            );
                            return (
                                <button
                                    key={b.id}
                                    type="button"
                                    onClick={() => {
                                        setSelectedSlot({
                                            index: i,
                                            isField: false,
                                            level: b.level,
                                            type: b.type,
                                        });
                                        setModalOpen(true);
                                    }}
                                    className="h-24 rounded-lg border border-slate-700 bg-slate-900/80 shadow-sm flex flex-col items-center justify-center px-2 relative active:bg-slate-800/80"
                                >
                                    {b.type ? (
                                        <>
                                            <div className="font-semibold text-xs text-center text-slate-50 mb-1">
                                                {BUILDING_TYPES[b.type].name}
                                            </div>
                                            <div className="text-[11px] bg-slate-800 px-2 py-0.5 rounded text-slate-200">
                                                Lvl {b.level}
                                            </div>
                                        </>
                                    ) : (
                                        <div className="text-slate-500 text-xs font-medium">
                                            Empty Slot
                                        </div>
                                    )}

                                    {isBuilding && (
                                        <div className="absolute inset-0 bg-emerald-500/10 rounded-lg border border-emerald-400 flex flex-col items-center justify-center">
                                            <span className="text-[11px] font-bold text-emerald-100 bg-slate-900/80 px-2 py-1 rounded">
                                                Construction
                                            </span>
                                        </div>
                                    )}
                                </button>
                            );
                        })}
                    </div>

                    <div className="mt-5 bg-slate-900/90 border border-slate-700 text-slate-50 rounded-lg p-3 shadow">
                        <div className="flex justify-between items-center mb-2">
                            <div className="flex items-center gap-2">
                                <Icons.Sword />
                                <h3 className="font-semibold text-sm">Army</h3>
                            </div>
                            <span className="text-amber-300 font-mono text-sm">
                                {state.troops.legionnaire} units
                            </span>
                        </div>
                        {state.trainingQueue.length > 0 && (
                            <div className="text-[11px] text-slate-300 bg-slate-800/80 px-2 py-1.5 rounded">
                                Training {state.trainingQueue[0].amount} units...
                            </div>
                        )}
                        {state.trainingQueue.length === 0 && (
                            <div className="text-[11px] text-slate-400">
                                No units training. Build a Barracks to train troops.
                            </div>
                        )}
                    </div>

                    <div className="mt-5 bg-slate-900/90 border border-amber-700/70 text-slate-50 rounded-lg p-3 shadow">
                        <div className="flex justify-between items-center mb-2">
                            <div className="flex items-center gap-2">
                                <span className="text-amber-300 text-lg">â˜…</span>
                                <h3 className="font-semibold text-sm">Quests</h3>
                            </div>
                            <span className="text-[10px] uppercase text-amber-300">
                                Goals
                            </span>
                        </div>
                        <div className="space-y-2 max-h-40 overflow-y-auto game-scroll">
                            {state.quests && state.quests.length > 0 ? (
                                state.quests.map((q) => (
                                    <div
                                        key={q.id}
                                        className="border border-slate-700/80 bg-slate-950/80 rounded-md px-2.5 py-2 flex justify-between items-start gap-2"
                                    >
                                        <div>
                                            <div className="text-xs font-semibold text-slate-50">
                                                {q.title}
                                            </div>
                                            <div className="text-[11px] text-slate-300">
                                                {q.desc}
                                            </div>
                                        </div>
                                        <div className="flex flex-col items-end gap-1">
                                            <span
                                                className={
                                                    "text-[10px] px-2 py-0.5 rounded-full " +
                                                    (q.claimed
                                                        ? "bg-emerald-900/70 text-emerald-300"
                                                        : q.completed
                                                        ? "bg-amber-900/70 text-amber-300"
                                                        : "bg-slate-800 text-slate-300")
                                                }
                                            >
                                                {q.claimed
                                                    ? "Claimed"
                                                    : q.completed
                                                    ? "Ready"
                                                    : "In progress"}
                                            </span>
                                            {q.completed && !q.claimed && (
                                                <button
                                                    type="button"
                                                    onClick={() => claimQuest(q.id)}
                                                    className="bg-emerald-600 hover:bg-emerald-700 text-white text-[10px] font-semibold px-2.5 py-1 rounded-md active:scale-95 transition-transform"
                                                >
                                                    Claim
                                                </button>
                                            )}
                                        </div>
                                    </div>
                                ))
                            ) : (
                                <div className="text-center text-slate-500 text-xs py-2">
                                    No quests available right now.
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );

            const MapView = () => {
                const targets = ["Rat Cave", "Abandoned Valley", "Bandit Camp", "Oasis"];

                return (
                    <div className="px-4 py-4 pb-24">
                        <div className="text-center mb-4">
                            <h2 className="text-lg font-semibold text-emerald-100">World Map</h2>
                            <p className="text-[11px] text-slate-300">
                                Send raids to gather extra resources.
                            </p>
                        </div>

                        {state.missions.length > 0 && (
                            <div className="mb-4 space-y-2">
                                <h3 className="text-[11px] font-semibold uppercase text-slate-300">
                                    Active Movements
                                </h3>
                                {state.missions.map((m, i) => (
                                    <div
                                        key={i}
                                        className="bg-sky-950/70 border border-sky-700/70 px-3 py-2 rounded-lg flex justify-between items-center"
                                    >
                                        <div>
                                            <div className="font-semibold text-xs text-sky-100">
                                                {m.type === "raid" ? "Raiding" : "Returning"}{" "}
                                                {m.target}
                                            </div>
                                            <div className="text-[11px] text-sky-300">
                                                {m.troops} troops
                                            </div>
                                        </div>
                                        <div className="text-[11px] font-mono bg-sky-900/80 px-2 py-1 rounded text-sky-100">
                                            {Math.max(
                                                0,
                                                Math.ceil((m.returnTime - Date.now()) / 1000)
                                            )}
                                            s
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}

                        <div className="space-y-3">
                            {targets.map((t) => (
                                <div
                                    key={t}
                                    className="bg-slate-900/90 border border-slate-700 rounded-lg px-3 py-3 flex justify-between items-center shadow-sm"
                                >
                                    <div className="flex items-center gap-3">
                                        <div className="bg-red-900/40 border border-red-700/60 p-2 rounded-full text-red-300">
                                            <Icons.Map />
                                        </div>
                                        <span className="font-medium text-sm text-slate-50">{t}</span>
                                    </div>
                                    <button
                                        type="button"
                                        onClick={() => sendRaid(t)}
                                        className="bg-red-600 hover:bg-red-700 text-white px-3 py-1.5 rounded-md text-xs font-semibold active:scale-95 transition-transform"
                                    >
                                        Raid
                                    </button>
                                </div>
                            ))}
                        </div>

                        <div className="mt-5">
                            <h3 className="text-[11px] font-semibold uppercase text-slate-300 mb-2">
                                Latest Reports
                            </h3>
                            <div className="space-y-2">
                                {state.reports.slice(0, 5).map((r) => (
                                    <div
                                        key={r.id}
                                        className="bg-slate-900/80 border border-slate-700 px-3 py-2 rounded text-xs text-slate-100"
                                    >
                                        <div className="flex justify-between mb-1">
                                            <span className="font-semibold">{r.title}</span>
                                            <span className="text-[10px] text-slate-400">
                                                {r.time}
                                            </span>
                                        </div>

                                        {typeof r.troopsLost === "number" && (
                                            <div className="text-[10px] text-red-300 mb-1">
                                                Losses: {r.troopsLost}/{r.troopsSent} troops did not
                                                return.
                                            </div>
                                        )}

                                        <div className="flex gap-3 flex-wrap text-[11px] text-slate-200">
                                            <span className="flex items-center gap-1">
                                                <Icons.Wood /> {r.loot.wood}
                                            </span>
                                            <span className="flex items-center gap-1">
                                                <Icons.Clay /> {r.loot.clay}
                                            </span>
                                            <span className="flex items-center gap-1">
                                                <Icons.Iron /> {r.loot.iron}
                                            </span>
                                            <span className="flex items-center gap-1">
                                                <Icons.Crop /> {r.loot.crop}
                                            </span>
                                        </div>
                                    </div>
                                ))}
                                {state.reports.length === 0 && (
                                    <div className="text-center text-slate-500 text-xs py-3">
                                        No reports yet. Go annoy some bandits. ðŸ™‚
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                );
            };

            const BuildingModal = () => {
                if (!modalOpen || !selectedSlot) return null;

                const { isField, level, type, index } = selectedSlot;

                // Empty village slot: choose building to construct
                if (!type && !isField) {
                    return (
                        <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/60">
                            <div className="bg-slate-950 w-full max-w-md px-4 py-4 rounded-t-2xl sm:rounded-2xl shadow-xl border border-slate-800">
                                <div className="flex justify-between items-center mb-3">
                                    <h3 className="text-sm font-semibold text-slate-50">
                                        Construct Building
                                    </h3>
                                    <button
                                        type="button"
                                        onClick={() => setModalOpen(false)}
                                        className="p-1 rounded-full hover:bg-slate-800"
                                    >
                                        <Icons.X />
                                    </button>
                                </div>
                                <div className="space-y-3">
                                    {["mainbuilding", "warehouse", "granary", "barracks"].map(
                                        (bKey) => {
                                            const count = state.buildings.filter(
                                                (b) => b.type === bKey
                                            ).length;
                                            if (bKey === "mainbuilding" && count > 0) return null;

                                            const b = BUILDING_TYPES[bKey];
                                            const costs = b.cost;

                                            return (
                                                <div
                                                    key={bKey}
                                                    className="border border-slate-700 rounded-lg px-3 py-2.5 flex justify-between items-center bg-slate-900/80"
                                                >
                                                    <div className="mr-2">
                                                        <div className="font-semibold text-xs text-slate-50 mb-0.5">
                                                            {b.name}
                                                        </div>
                                                        <div className="text-[11px] text-slate-300 mb-1.5">
                                                            {b.desc}
                                                        </div>
                                                        <div className="flex gap-2 text-[10px] font-mono text-slate-200">
                                                            <span className="flex items-center gap-1">
                                                                <Icons.Wood /> {costs[0]}
                                                            </span>
                                                            <span className="flex items-center gap-1">
                                                                <Icons.Clay /> {costs[1]}
                                                            </span>
                                                            <span className="flex items-center gap-1">
                                                                <Icons.Iron /> {costs[2]}
                                                            </span>
                                                            <span className="flex items-center gap-1">
                                                                <Icons.Crop /> {costs[3]}
                                                            </span>
                                                        </div>
                                                    </div>
                                                    <button
                                                        type="button"
                                                        onClick={() => {
                                                            const costs = b.cost;
                                                            if (
                                                                state.resources.wood < costs[0] ||
                                                                state.resources.clay < costs[1] ||
                                                                state.resources.iron < costs[2] ||
                                                                state.resources.crop < costs[3]
                                                            ) {
                                                                alert("Not enough resources!");
                                                                return;
                                                            }
                                                            setState((prev) => {
                                                                const mainLevel = getMainBuildingLevel(
                                                                    prev.buildings
                                                                );
                                                                const baseTime = 10000;
                                                                const timeFactor =
                                                                    1 -
                                                                    Math.min(
                                                                        0.4,
                                                                        mainLevel * 0.05
                                                                    );
                                                                const buildTime =
                                                                    (baseTime * timeFactor) /
                                                                    SPEED_MULTIPLIER;

                                                                return {
                                                                    ...prev,
                                                                    resources: {
                                                                        wood:
                                                                            prev.resources.wood -
                                                                            costs[0],
                                                                        clay:
                                                                            prev.resources.clay -
                                                                            costs[1],
                                                                        iron:
                                                                            prev.resources.iron -
                                                                            costs[2],
                                                                        crop:
                                                                            prev.resources.crop -
                                                                            costs[3],
                                                                    },
                                                                    constQueue: [
                                                                        ...prev.constQueue,
                                                                        {
                                                                            type: bKey,
                                                                            index,
                                                                            level: 1,
                                                                            finishTime:
                                                                                Date.now() +
                                                                                buildTime,
                                                                            isField: false,
                                                                        },
                                                                    ],
                                                                };
                                                            });
                                                            setModalOpen(false);
                                                        }}
                                                        className="bg-emerald-600 hover:bg-emerald-700 text-white text-[11px] font-semibold px-3 py-1.5 rounded-md active:scale-95 transition-transform"
                                                    >
                                                        Build
                                                    </button>
                                                </div>
                                            );
                                        }
                                    )}
                                </div>
                            </div>
                        </div>
                    );
                }

                const nextCost = getCost(type, level);
                const building = BUILDING_TYPES[type];

                return (
                    <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/60">
                        <div className="bg-slate-950 w-full max-w-md px-4 py-4 rounded-t-2xl sm:rounded-2xl shadow-xl border border-slate-800">
                            <div className="flex justify-between items-center mb-3">
                                <div>
                                    <h3 className="text-sm font-semibold text-slate-50">
                                        {building.name}{" "}
                                        <span className="text-slate-400 text-[11px]">
                                            Level {level}
                                        </span>
                                    </h3>
                                    <p className="text-[11px] text-slate-300 mt-1">
                                        {isField
                                            ? `Production: ${getProduction(
                                                  type,
                                                  level
                                              )} â†’ ${getProduction(
                                                  type,
                                                  level + 1
                                              )} per hour`
                                            : building.desc}
                                    </p>
                                </div>
                                <button
                                    type="button"
                                    onClick={() => setModalOpen(false)}
                                    className="p-1 rounded-full hover:bg-slate-800"
                                >
                                    <Icons.X />
                                </button>
                            </div>

                            {type === "barracks" && level > 0 && (
                                <div className="mb-4 bg-slate-900/80 border border-slate-700 px-3 py-3 rounded-lg">
                                    <h4 className="font-semibold text-xs text-slate-50 mb-1.5">
                                        Train Legionnaire
                                    </h4>
                                    <div className="flex justify-between items-center">
                                        <div className="text-[11px] text-slate-200">
                                            Cost: 120{" "}
                                            <span className="inline-flex items-center">
                                                <Icons.Wood />
                                            </span>{" "}
                                            100{" "}
                                            <span className="inline-flex items-center">
                                                <Icons.Clay />
                                            </span>{" "}
                                            150{" "}
                                            <span className="inline-flex items-center">
                                                <Icons.Iron />
                                            </span>{" "}
                                            30{" "}
                                            <span className="inline-flex items-center">
                                                <Icons.Crop />
                                            </span>
                                        </div>
                                        <button
                                            type="button"
                                            onClick={() => {
                                                const amt = parseInt(
                                                    prompt("Amount:", "5"),
                                                    10
                                                );
                                                if (amt) trainTroops(amt);
                                            }}
                                            className="bg-slate-800 hover:bg-slate-700 text-white px-3 py-1.5 rounded text-[11px] font-semibold active:scale-95 transition-transform"
                                        >
                                            Train
                                        </button>
                                    </div>
                                </div>
                            )}

                            <div className="bg-slate-900/80 border border-slate-700 px-3 py-3 rounded-lg mb-1">
                                <h4 className="font-semibold text-xs text-slate-50 mb-2">
                                    Upgrade to Level {level + 1}
                                </h4>
                                <div className="grid grid-cols-4 gap-2 mb-3">
                                    <div
                                        className={`text-center ${
                                            state.resources.wood < nextCost[0]
                                                ? "text-red-400"
                                                : "text-slate-100"
                                        } text-[11px]`}
                                    >
                                        <div className="flex justify-center mb-0.5">
                                            <Icons.Wood />
                                        </div>
                                        <span className="font-mono font-semibold">
                                            {nextCost[0]}
                                        </span>
                                    </div>
                                    <div
                                        className={`text-center ${
                                            state.resources.clay < nextCost[1]
                                                ? "text-red-400"
                                                : "text-slate-100"
                                        } text-[11px]`}
                                    >
                                        <div className="flex justify-center mb-0.5">
                                            <Icons.Clay />
                                        </div>
                                        <span className="font-mono font-semibold">
                                            {nextCost[1]}
                                        </span>
                                    </div>
                                    <div
                                        className={`text-center ${
                                            state.resources.iron < nextCost[2]
                                                ? "text-red-400"
                                                : "text-slate-100"
                                        } text-[11px]`}
                                    >
                                        <div className="flex justify-center mb-0.5">
                                            <Icons.Iron />
                                        </div>
                                        <span className="font-mono font-semibold">
                                            {nextCost[2]}
                                        </span>
                                    </div>
                                    <div
                                        className={`text-center ${
                                            state.resources.crop < nextCost[3]
                                                ? "text-red-400"
                                                : "text-slate-100"
                                        } text-[11px]`}
                                    >
                                        <div className="flex justify-center mb-0.5">
                                            <Icons.Crop />
                                        </div>
                                        <span className="font-mono font-semibold">
                                            {nextCost[3]}
                                        </span>
                                    </div>
                                </div>
                                <button
                                    type="button"
                                    onClick={() => upgradeBuilding(type)}
                                    className="w-full bg-emerald-600 hover:bg-emerald-700 text-white py-2.5 rounded-lg text-xs font-semibold active:scale-95 transition-transform"
                                >
                                    Upgrade ({10 / SPEED_MULTIPLIER}s)
                                </button>
                            </div>
                        </div>
                    </div>
                );
            };

            const BottomNav = () => (
                <nav className="safe-bottom bg-slate-950/95 border-t border-slate-800 flex justify-around py-2.5 px-2">
                    <button
                        type="button"
                        onClick={() => setActiveTab("fields")}
                        className={`flex flex-col items-center gap-0.5 flex-1 ${
                            activeTab === "fields" ? "text-emerald-400" : "text-slate-400"
                        }`}
                    >
                        <Icons.Crop />
                        <span className="text-[10px] font-semibold uppercase tracking-wide">
                            Fields
                        </span>
                    </button>
                    <button
                        type="button"
                        onClick={() => setActiveTab("village")}
                        className={`flex flex-col items-center gap-0.5 flex-1 ${
                            activeTab === "village" ? "text-emerald-400" : "text-slate-400"
                        }`}
                    >
                        <Icons.Home />
                        <span className="text-[10px] font-semibold uppercase tracking-wide">
                            Village
                        </span>
                    </button>
                    <button
                        type="button"
                        onClick={() => setActiveTab("map")}
                        className={`flex flex-col items-center gap-0.5 flex-1 ${
                            activeTab === "map" ? "text-emerald-400" : "text-slate-400"
                        }`}
                    >
                        <Icons.Map />
                        <span className="text-[10px] font-semibold uppercase tracking-wide">
                            Map
                        </span>
                    </button>
                </nav>
            );

            return (
                <div className="w-full h-full bg-gradient-to-b from-emerald-900 via-emerald-950 to-slate-950 flex items-stretch justify-center">
                    <div className="w-full max-w-md h-full bg-slate-950/95 text-slate-100 shadow-[0_0_40px_rgba(0,0,0,0.8)] flex flex-col">
                        <TopBar />
                        <ResourceBar />

                        <main className="flex-1 overflow-y-auto overflow-x-hidden game-scroll">
                            {activeTab === "fields" && <FieldsView />}
                            {activeTab === "village" && <VillageView />}
                            {activeTab === "map" && <MapView />}
                        </main>

                        <BottomNav />
                        <BuildingModal />
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById("root"));
        root.render(<App />);
    </script>
</body>
</html>
